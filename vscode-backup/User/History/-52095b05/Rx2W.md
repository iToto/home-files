# yield-mvp

Yield MVP service

## Overview

The `yield-mvp` application is designed to provide a minimal viable product (MVP) for yield-related services. It is a backend service that handles various operations related to yield management.

## Configurations

The application requires a configuration file for the appropriate environment to run. The supported environments are:

- Local
- Docker (Production)

The configuration files are stored in the `configs/` directory in the format `env.{ENVIRONMENT}`. A starting environment file with all required keys can be found at `configs/env.example`.

This application is run on GCP using Cloud Run and leverages docker images within the docker registry on GCP. Therefore, production environment is set in a `env.docker` file and is used locally when the docker image is build and pushed up to GCP.

## Running the Application Locally

To run the application locally, use the following command:

```sh
$ make run
```

This command will start the application using the local configuration.

# Features

- Yield Management: Core functionality for managing yield-related operations.
- Environment Configurations: Supports multiple environments with separate configuration files.
- Easy Setup: Simple commands to run the application locally.

# System Design

This application has multiple services packaged into one:

* Trading app
* HTTP API

Here is a brief description of each:

## Trading App

The trading app runs on a continuous loop whose cadence is determined by a configurable timer. Every loop, it will query the DB for all the active signals and their paired active strategies. It will them loop through each signal, request the current signal, log it, then loop through each strategy and see if there is an action to take. Each strategy is configurable to run different heuristics. These are determined by the properties set on the `entities.Strategy` Object (persisted in the DB).

The app and it's dependencies are setup in `main.go`. It does quite a bit:

- Loads in secrets from environments
- Sets up DB connection
- Setup and connect web sockets for real time BTC and ETH price checks
- Sets the user (right now only setup for 1 user: Dan)
- Sets up Data Access Layer (DAL) which is what is used to retrieve data from dependencies
- Sets up CoinRoutes API client
- Sets up all the data loggers (these log to BigQuery)
- Sets up services 
  - Signal service which gets and processes signal
  - Report service which is tied to the `/report ` API endpoint which triggers a report generation (is hit by a cloud scheduled job in GCP)
- Sets up API Routes and binds to HTTP handlers
  - This includes many things such as the API to manage Strategies along with reporting APIs


## HTTP API

As mentioned above, this app also hosts a list of APIs that have various usages. 
The majority of the endpoints are used for Strategy management. There are other APIs
used for reporting. Most of these are called automatically via a cloud scheduled API call
[setup in GCP](https://console.cloud.google.com/cloudscheduler?project=yieldchain-track-records)

# Deployments

Deployments are done via the `Makefile` in conjunction with GCP and Docker. You will need
to create a new docker image which gets pushed to the image registry on GCP. Once that is done you can deploy the image to Cloud Run. To facilitate this, I usually run these two make targets:

```sh
make docker/build-and-push-image && make cloudrun/deploy
```

> **NB:** You will need the appropriate GCP IAM permissions on your user account and on your computer to be permitted to run these commands. You will also need the proper env.docker config file to ensure the container is using the appropriate secrets.

This will build and push up the docker image followed by deploy that image to cloud run.

**IMPORTANT:** Because this app runs on a loop, it is vital that when deploying a new instance you kill the existing instance to avoid double processing. CloudRun is designed for HTTP traffic services, so it manages traffic to bring down a service. However that would not do anything in our case as the service would continue to run even though no traffic is being sent to it.

# Dashboards & Logs

I made a custom dashboard that highlight the vital signs of the service and API. 

You can visit that [here](https://console.cloud.google.com/monitoring/dashboards/builder/deceeec0-c255-4c6b-84f4-ad0d8b25cde6;duration=P7D?project=yieldchain-track-records&pageState=(%22eventTypes%22:(%22selected%22:%5B%22CLOUD_ALERTING_ALERT%22,%22CLOUD_RUN_DEPLOYMENT%22,%22CLOUD_SQL_STORAGE%22%5D)))

As for loggs, I generally view the error logs from the last 7 days [here](https://cloudlogging.app.goo.gl/Bf2gnunsGzBQivu6A).

# Dependencies

## API

You can find all HTTP API dependencies in: `pkg/`. The main one is `coinroutes` which uses API keys and secrets generated by Yield and used by the app.

There is also a dependency on the Signal APIs which is a generic API package that takes in a URL (signals set by user at runtime) makes a request and returns the signal response to be processed by the application.

## GCP

This application run on the Google Cloud Platform and is dependant on some services there. Most notably Cloud Run. 

# Directory Structure

### configs/: Contains configuration files for different environments

### handlers/: HTTP handlers for the application's endpoints

### models/: Data structures and database models

### services/: Business logic and core functionalities

### utils/: Utility functions and helpers

### middleware/: Middleware functions for request processing

### db/: Database interaction functions

### routes/: Routing configuration for the application

### pkg/: Dependencies and helpers for the application





Getting Started

Clone the repository:
```sh
git clone https://github.com/yourusername/yield-mvp.git
cd yield-mvp
```

Copy the example environment file and modify it as needed:

```sh
cp configs/env.example configs/env.local
```

Install dependencies:

```sh
make install
```

Run the application:

```sh
make run
```
